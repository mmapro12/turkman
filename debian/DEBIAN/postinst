#!/bin/bash
set -e

echo "ğŸ”§ Turkman kurulum sonrasÄ± yapÄ±landÄ±rma..."

# GerÃ§ek kullanÄ±cÄ±yÄ± ve home dizinini tespit et
get_real_user_info() {
    # EÄŸer SUDO_USER varsa, bu gerÃ§ek kullanÄ±cÄ±dÄ±r
    if [ -n "$SUDO_USER" ] && [ "$SUDO_USER" != "root" ]; then
        REAL_USER="$SUDO_USER"
        REAL_HOME=$(getent passwd "$SUDO_USER" | cut -d: -f6)
    # EÄŸer SUDO_UID varsa, bu yÃ¶ntemi kullan
    elif [ -n "$SUDO_UID" ] && [ "$SUDO_UID" != "0" ]; then
        REAL_USER=$(getent passwd "$SUDO_UID" | cut -d: -f1)
        REAL_HOME=$(getent passwd "$SUDO_UID" | cut -d: -f6)
    # Son Ã§are olarak, tty'nin sahibini kontrol et
    else
        TTY_OWNER=$(stat -c '%U' "$(tty 2>/dev/null)" 2>/dev/null || echo "")
        if [ -n "$TTY_OWNER" ] && [ "$TTY_OWNER" != "root" ]; then
            REAL_USER="$TTY_OWNER"
            REAL_HOME=$(getent passwd "$TTY_OWNER" | cut -d: -f6)
        else
            # HiÃ§biri iÅŸe yaramazsa, varsayÄ±lan deÄŸerler
            REAL_USER=""
            REAL_HOME=""
        fi
    fi
}

# KullanÄ±cÄ± bilgilerini al
get_real_user_info

if command -v turkman >/dev/null 2>&1; then
    if [ -n "$REAL_USER" ] && [ -n "$REAL_HOME" ] && [ -d "$REAL_HOME" ]; then
        echo "ğŸ‘¤ GerÃ§ek kullanÄ±cÄ± tespit edildi: $REAL_USER ($REAL_HOME)"
        
        # KullanÄ±cÄ±nÄ±n UID ve GID'sini al
        USER_UID=$(id -u "$REAL_USER")
        USER_GID=$(id -g "$REAL_USER")
        
        echo "ğŸ“Š VeritabanÄ± baÅŸlatÄ±lÄ±yor..."
        # GerÃ§ek kullanÄ±cÄ± olarak turkman komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±r
        sudo -u "$REAL_USER" -H bash -c "
            export HOME='$REAL_HOME'
            cd '$REAL_HOME'
            turkman db init
        " || true
        
        echo "ğŸ”„ Ã‡eviriler senkronize ediliyor..."
        sudo -u "$REAL_USER" -H bash -c "
            export HOME='$REAL_HOME'
            cd '$REAL_HOME'
            turkman db sync
        " || true
        
        # .turkmandb dizininin doÄŸru sahiplik ve izinlerini ayarla
        TURKMAN_DB_DIR="$REAL_HOME/.turkmandb"
        if [ -d "$TURKMAN_DB_DIR" ]; then
            echo "ğŸ” Dizin izinleri dÃ¼zenleniyor..."
            chown -R "$USER_UID:$USER_GID" "$TURKMAN_DB_DIR"
            chmod -R 755 "$TURKMAN_DB_DIR"
        fi
        
    else
        echo "âš ï¸  GerÃ§ek kullanÄ±cÄ± tespit edilemedi, sistem geneli kurulum yapÄ±lÄ±yor..."
        echo "ğŸ“Š VeritabanÄ± baÅŸlatÄ±lÄ±yor..."
        turkman db init || true
        
        echo "ğŸ”„ Ã‡eviriler senkronize ediliyor..."
        turkman db sync || true
        
        echo "ğŸ’¡ Not: LÃ¼tfen ilk kullanÄ±mdan Ã¶nce 'turkman db init' komutunu Ã§alÄ±ÅŸtÄ±rÄ±n."
    fi
else
    echo "âŒ turkman komutu bulunamadÄ±!"
    exit 1
fi

echo "âœ… Turkman baÅŸarÄ±yla kuruldu!"
echo "ğŸ’¡ KullanÄ±m: turkman <komut_adÄ±>"
echo "ğŸ“– YardÄ±m: turkman --help"

# EÄŸer gerÃ§ek kullanÄ±cÄ± tespit edildiyse, onu bilgilendir
if [ -n "$REAL_USER" ]; then
    echo "ğŸ  VeritabanÄ± konumu: $REAL_HOME/.turkmandb"
fi

exit 0
